D:\My_Django_Projects\aup_ci_repository>workon aup_ci
(aup_ci) D:\My_Django_Projects\aup_ci_repository>python manage.py createsuperuser --settings=config.settings.dev
Nom d’utilisateur (leave blank to use 'amanv'): ferdiBest
Adresse électronique: amanvon238@gmail.com
Password:
Password (again):
Superuser created successfully.

Liens utiles utilisées lors du codes :
- Newsletter : https://www.twilio.com/blog/build-email-newsletter-django-twilio-sendgrid
- Model Relationship: https://www.remoteinning.com/blog/how-to-effectively-design-relations-between-your-django-models
- Documentation django: https://docs.djangoproject.com/fr/3.2/topics/
- Form with bootstrap:
    1. https://simpleisbetterthancomplex.com/tutorial/2018/11/28/advanced-form-rendering-with-django-crispy-forms.html
    2. https://www.ordinarycoders.com/blog/article/render-a-django-form-with-bootstrap

- app ou pages pour seminaires et conférences :
    1. https://framagit.org/manu/django-seminar/-/tree/master
    2. https://github.com/lucasvo/django-event-app
    3. https://www.vinta.com.br/blog/2017/advanced-django-querying-sorting-events-date/

- Snippet pour calendar events:
    1. https://djangosnippets.org/snippets/2223/
- Paginator:
    1. https://simpleisbetterthancomplex.com/tutorial/2016/08/03/how-to-paginate-with-django.html






from django.shortcuts import render, get_object_or_404
#from django.shortcuts import get_object_or_404
from .forms import ContactForm, AdhesionForm, AbonneNewForm, ParticiperForm
from django.http import HttpResponseRedirect
from django.contrib import messages
from django.utils import timezone
from django.db import models
from django.db.models import F, Q
from .models import Evenement
from .helpers import base_navigue_view
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger

def home(request):
   render_page = "aup_ci/index.html"
   http_redirect = "/"
   http_response = base_navigue_view(request, render_page, http_redirect)
   return http_response

def about(request):
    render_page = "aup_ci/about.html"
    http_redirect = "/about"
    http_response= base_navigue_view(request, render_page, http_redirect)
    return  http_response

def event(request, page=1):
    if request.method == 'POST':

        # create a form instance and populate it with data from the request:
        new_form = AbonneNewForm(request.POST)
        # check whether it's valid:
        if new_form.is_valid():
            # process the data in form.cleaned_data as required
            # Save in the data base
            new_form.save()
            # add flashmessages
            messages.add_message(request, messages.SUCCESS,
                                     "Votre demande d'abonnement à notre newsletter a été enregistrée et sera traitée")
            # redirect to a new URL:
            return HttpResponseRedirect('/event')

    # if a GET (or any other method) we'll create a blank form
    else:
        # Gérer l'affichage des événements ici
        # Une section pour l'affichage des événèments à venir, et une section pour les évènements passés
        now = timezone.now()
        evenements=(Evenement.objects.annotate(
            relevance=models.Case(
                models.When(date_debut__gte=now, then=1),
                models.When(date_debut__lt=now, then=2),
                output_field=models.IntegerField(),
            )).annotate(
            timediff=models.Case(
                models.When(date_debut__gte=now, then=F('date_creation') - now),
                models.When(date_debut__lt=now, then=now - F('date_creation')),
                output_field=models.DurationField(),
            )).order_by('relevance', 'timediff'))#.filter(relevance=1)
        aVenir = []
        passer = []
        for evenement in evenements:
            if evenement.date_debut >= now:
                aVenir.append(evenement)
            else:
                passer.append(evenement)
        #print(aVenir)
        #print(passer)
        page_number = request.GET.get('page')
        paginator = Paginator(passer, 1)  # Show 25 contacts per page.
        try:
            past_events = paginator.page(page_number)
        except PageNotAnInteger:
            past_events = paginator.page(1)
        except EmptyPage:
            past_events = paginator.page(paginator.num_pages)
        new_form = AbonneNewForm(None)
    return render(request, "aup_ci/event.html", {'newform': new_form, 'event_aVenir': aVenir, 'event_passer': past_events})


def show_event_Passer(request, event_id=0):
    if event_id == 0:
        return HttpResponseRedirect('/event')
    else:
        #print("ID_EVENT={} de Type".format(event_id, type(event_id)))
        evenement = get_object_or_404(Evenement, pk=event_id)
        now = timezone.now()
        es_a_venir = 1
        if evenement.date_debut < now:
            es_a_venir = 0
            #new_form = AbonneNewForm(None)
            render_page = "aup_ci/eventDetail.html"
            http_redirect = '/event/passe/'+str(event_id)
            data = {'evenement': evenement, 'es_a_venir': es_a_venir}
            httpresponse = base_navigue_view(request, render_page, http_redirect, data)
            return httpresponse
        else:
            return HttpResponseRedirect('/event/avenir/'+str(event_id))

        #return  render(request, "aup_ci/eventDetail.html", {'newform': new_form})


def show_event_Avenir(request, event_id=0):
    if event_id == 0:
        return HttpResponseRedirect('/event')
    else:
        #print("ID_EVENT={} de Type".format(event_id, type(event_id)))
        evenement = get_object_or_404(Evenement, pk=event_id)
        now = timezone.now()
        es_a_venir = 0
        if evenement.date_debut > now:
            es_a_venir = 1
            if request.method == 'POST':
                if "detail_event" in request.POST:
                    # create a form instance and populate it with data from the request:
                    other_form = ParticiperForm(request.POST)
                    # check whether it's valid:
                    if other_form.is_valid():
                        # process the data in form.cleaned_data as required
                        # Envoyer un email à l'administrateur

                        # add flashmessages
                        messages.add_message(request, messages.SUCCESS,
                                             "Votre demande de participation a été enregistrée et sera traitée")
                        # redirect to a new URL:
                        return HttpResponseRedirect('/event/avenir/'+str(event_id))
                elif "abonne" in request.POST:
                    # create a form instance and populate it with data from the request:
                    new_form = AbonneNewForm(request.POST)
                    # check whether it's valid:
                    if new_form.is_valid():
                        # process the data in form.cleaned_data as required
                        # Save in the data base
                        new_form.save()
                        # add flashmessages
                        messages.add_message(request, messages.SUCCESS,
                                             "Votre demande d'abonnement à notre newsletter a été enregistrée et sera traitée")
                        # Envoie de mail à l'administrateur et au demander
                        # redirect to a new URL:
                        return HttpResponseRedirect('/event/avenir/'+str(event_id))
            else:
                render_page = "aup_ci/eventDetail.html"
                http_redirect = '/event/avenir/'+str(event_id)
                form_event = ParticiperForm(None)
                data = {'evenement': evenement, 'es_a_venir': es_a_venir, 'event_form': form_event}
                httpresponse = base_navigue_view(request, render_page, http_redirect, data)
                return httpresponse
        else:
            return HttpResponseRedirect('/event/passe/'+str(event_id))

        #new_form = AbonneNewForm(None)
        #return  render(request, "aup_ci/eventDetail.html", {'newform': new_form})



def contact(request):
    # if this is a POST request we need to process the form data
    if request.method == 'POST':
        if "contact" in request.POST:
            # create a form instance and populate it with data from the request:
            contact_form = ContactForm(request.POST)
            # check whether it's valid:
            if contact_form.is_valid():
                # process the data in form.cleaned_data as required
                #Envoyer un mail
                # add flashmessages
                messages.add_message(request, messages.SUCCESS,
                                     "Votre préoccupation a été enregistrée et sera traitée rapidement")
                # redirect to a new URL:
                return HttpResponseRedirect('/contact')
        elif "abonne" in request.POST:
            # create a form instance and populate it with data from the request:
            new_form = AbonneNewForm(request.POST)
            # check whether it's valid:
            if new_form.is_valid():
                # process the data in form.cleaned_data as required
                # Save in the data base
                new_form.save()
                # add flashmessages
                messages.add_message(request, messages.SUCCESS,
                                     "Votre demande d'abonnement à notre newsletter a été enregistrée et sera traitée")
                # redirect to a new URL:
                return HttpResponseRedirect('/contact')

    # if a GET (or any other method) we'll create a blank form
    else:
        contact_form = ContactForm(None)
        new_form = AbonneNewForm(None)
    return render(request, "aup_ci/contact.html", {'contactform': contact_form, 'newform': new_form})


def adhesion(request):
    # if this is a POST request we need to process the form data
    #adhere_form = AdhesionForm(None)
    #new_form  = AbonneNewForm(None)
    if request.method == 'POST':
        if "adhere" in request.POST:
            # create a form instance and populate it with data from the request:
            adhere_form = AdhesionForm(request.POST)
            # check whether it's valid:
            if adhere_form.is_valid():
                # process the data in form.cleaned_data as required
                # Save in the data base
                adhere_form.save()
                # add flashmessages
                messages.add_message(request, messages.SUCCESS,
                                     "Votre demande d'adhesion a été enregistrée et sera traitée")
                # redirect to a new URL:
                return HttpResponseRedirect('/adhesion')
        elif "abonne" in request.POST:
            # create a form instance and populate it with data from the request:
            new_form = AbonneNewForm(request.POST)
            # check whether it's valid:
            if new_form.is_valid():
                # process the data in form.cleaned_data as required
                # Save in the data base
                new_form.save()
                # add flashmessages
                messages.add_message(request, messages.SUCCESS,
                                     "Votre demande d'abonnement à notre newsletter a été enregistrée et sera traitée")
                # Envoie de mail à l'administrateur et au demander
                # redirect to a new URL:
                return HttpResponseRedirect('/adhesion')

    # if a GET (or any other method) we'll create a blank form
    else:
        adhere_form = AdhesionForm(None)
        new_form = AbonneNewForm(None)
    return render(request, "aup_ci/adhesion.html", {'adhereform': adhere_form, 'newform': new_form})

